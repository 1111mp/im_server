<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>

<body>
	<input id="input" type="text">
	<button onclick="send()">发送</button>
	<br>
	<button onclick="getOfflineMsgs()">离线消息</button>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.0/axios.min.js"></script>
<script>
	let socket = io('http://192.168.80.208:3000', {
		transports: ['websocket'],
		query: { token: '105ab61a-eeb1-4232-92ba-e91587a972a3' },
		reconnectionAttempts: 20
	})

	socket.on('connect', data => {
		console.log('connect successed')
	})

	socket.on('disconnect', res => {
		console.log(res)
	})

	socket.on('connect_failed', res => {
		console.log(res)
	})

	socket.on('error', err => {
		console.log(err)
	})

	socket.on('receiveMsg', (msg, callback) => {
		console.log('receiveMsg')
		console.log(msg)
		callback({ code: 200 })
	})

	function invoke(type, args) {
		return new Promise((resolve, reject) => {
			socket.emit(
				'invoke',
				JSON.stringify({
					type, args
				}),
				(res) => {
					resolve(res)
				}
			)
		})
	}

	function send() {
		let input = document.getElementById('input')
		let msg = {
			msgId: uuidv4(),
			type: 0,
			sessionType: 0,
			content: input.value,
			sender: {
				userId: 10002
			},
			reciver: 10000
		}
		console.log(msg)
		invoke('send-msg', msg).then(res => {
			console.log(res)
		})
	}

	axios.interceptors.request.use(
		(config) => {
			if (!config.url) return Promise.resolve({});

			if (!/login|register/.test(config.url)) {
				config.headers['token'] = '105ab61a-eeb1-4232-92ba-e91587a972a3'; // getToken
			}
			return config;
		},
		(error) => {
			return Promise.reject(error);
		}
	);

	async function getOfflineMsgs() {
		let pageNo = 1, pageSize = 2, messages = [];

		function promise(pageNo, pageSize) {
			return new Promise((resolve, reject) => {
				axios.post('http://localhost:3000/chat/getOfflineMsgs', {
					pageNo,
					pageSize
				}).then(res => {
					resolve(res.data)
				})
			})
		}

		async function getOfflineMsgs(pageNo, pageSize, hasMore = true) {

			if (hasMore) {
				const res = await promise(pageNo, pageSize)
				const { hasMore, msgs } = res.data

				messages = messages.concat([...msgs])

				await getOfflineMsgs(++pageNo, pageSize, hasMore);
			} else {
				axios.post('http://localhost:3000/chat/getOfflineMsgs', {
					ack: true,
					pageSize
				}).then(res => {
					console.log(res)
				})
			}
		}

		await getOfflineMsgs(pageNo, pageSize)

		console.log(messages)
	}


</script>

</html>